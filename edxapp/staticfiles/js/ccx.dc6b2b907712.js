var edx=edx||{};!function($,_,Backbone,gettext){"use strict";edx.ccx=edx.ccx||{},edx.ccx.schedule=edx.ccx.schedule||{};var self;edx.ccx.schedule.reloadPage=function(){location.reload()},edx.ccx.schedule.UnitModel=Backbone.Model.extend({defaults:{location:"",display_name:"",start:null,due:null,category:"",hidden:!1,children:[]}}),edx.ccx.schedule.Schedule=Backbone.Collection.extend({model:edx.ccx.schedule.UnitModel,url:"ccx_schedule"}),edx.ccx.schedule.ScheduleView=Backbone.View.extend({initialize:function(){_.bindAll(this,"render"),this.schedule_collection=new edx.ccx.schedule.Schedule,this.schedule={},this.schedule_collection.bind("reset",this.render),this.schedule_collection.fetch({reset:!0}),this.chapter_select=$('form#add-unit select[name="chapter"]'),this.sequential_select=$('form#add-unit select[name="sequential"]'),this.vertical_select=$('form#add-unit select[name="vertical"]'),this.dirty=!1,self=this,$("#add-all").on("click",function(event){event.preventDefault(),self.schedule_apply(self.schedule,self.show),self.dirty=!0,self.schedule_collection.set(self.schedule),self.render()}),this.chapter_select.on("change",function(){var chapter_location=self.chapter_select.val();if(self.vertical_select.html("").prop("disabled",!0),"none"!==chapter_location){var chapter=self.find_unit(self.hidden,chapter_location);self.sequential_select.html("").append('<option value="all">'+gettext("All subsections")+"</option>").append(self.schedule_options(chapter.children)),self.sequential_select.prop("disabled",!1),$("#add-unit-button").prop("disabled",!1),self.set_datetime("start",chapter.start),self.set_datetime("due",chapter.due)}else self.sequential_select.html("").prop("disabled",!0)}),this.sequential_select.on("change",function(){var sequential_location=self.sequential_select.val();if("all"!==sequential_location){var chapter=self.chapter_select.val(),sequential=self.find_unit(self.hidden,chapter,sequential_location);self.vertical_select.html("").append('<option value="all">'+gettext("All units")+"</option>").append(self.schedule_options(sequential.children)),self.vertical_select.prop("disabled",!1),self.set_datetime("start",sequential.start),self.set_datetime("due",sequential.due)}else self.vertical_select.html("").prop("disabled",!0)}),this.vertical_select.on("change",function(){var vertical_location=self.vertical_select.val();if("all"!==vertical_location){var chapter=self.chapter_select.val(),sequential=self.sequential_select.val(),vertical=self.find_unit(self.hidden,chapter,sequential,vertical_location);self.set_datetime("start",vertical.start),self.set_datetime("due",vertical.due)}}),$("#add-unit-button").on("click",function(event){event.preventDefault();var chapter=self.chapter_select.val(),sequential=self.sequential_select.val(),vertical=self.vertical_select.val(),units=self.find_lineage(self.schedule,chapter,"all"===sequential?null:sequential,"all"===vertical?null:vertical),start=self.get_datetime("start"),due=self.get_datetime("due");units.map(self.show);var unit=units[units.length-1];self.schedule_apply([unit],self.show),void 0!==unit&&start&&(unit.start=start),void 0!==unit&&due&&(unit.due=due),self.schedule_collection.set(self.schedule),self.dirty=!0,self.render()}),$("#dirty-schedule #save-changes").on("click",function(event){event.preventDefault(),self.save()})},render:function(){return self.schedule=this.schedule_collection.toJSON(),self.hidden=this.pruned(self.schedule,function(node){return node.hidden||"vertical"!==node.category}),this.showing=this.pruned(self.schedule,function(node){return!node.hidden}),this.$el.html(schedule_template({chapters:this.showing})),$("table.ccx-schedule .sequential,.vertical").hide(),$("table.ccx-schedule .toggle-collapse").on("click",this.toggle_collapse),$("table.ccx-schedule .date a").each(function(){$(this).text()||$(this).text("Set date").addClass("empty")}),$("table.ccx-schedule .date a").attr("href","#enter-date-modal").leanModal({closeButton:".close-modal"}),$("table.ccx-schedule .due-date a").on("click",this.enterNewDate("due")),$("table.ccx-schedule .start-date a").on("click",this.enterNewDate("start")),$("table.ccx-schedule a#remove-all").on("click",function(event){event.preventDefault(),self.schedule_apply(self.schedule,self.hide),self.dirty=!0,self.schedule_collection.set(self.schedule),self.render()}),$("table.ccx-schedule a.remove-unit").on("click",function(){var row=$(this).closest("tr"),path=row.data("location").split(" "),unit=self.find_unit(self.schedule,path[0],path[1],path[2]);self.schedule_apply([unit],self.hide),self.schedule_collection.set(self.schedule),self.dirty=!0,self.render()}),this.hidden.length?(this.chapter_select.html("").append('<option value="none">'+gettext("Select a chapter")+"...</option>").append(self.schedule_options(this.hidden)),this.sequential_select.html("").prop("disabled",!0),this.vertical_select.html("").prop("disabled",!0),$("form#add-unit").show(),$("#all-units-added").hide(),$("#add-unit-button").prop("disabled",!0)):($("form#add-unit").hide(),$("#all-units-added").show()),this.dirty?$("#dirty-schedule").show():$("#dirty-schedule").hide(),$("#ajax-error").hide(),this},save:function(){self.schedule_collection.set(self.schedule);var button=$("#dirty-schedule #save-changes");button.prop("disabled",!0).text(gettext("Saving")+"..."),$.ajax({url:save_url,type:"POST",contentType:"application/json",data:JSON.stringify(self.schedule),success:function(data){self.dirty=!1,self.render(),button.prop("disabled",!1).text(gettext("Save changes")),$("#grading-policy").text(data.grading_policy)},error:function(jqXHR){console.log(jqXHR.responseText),$("#ajax-error").show(),$("#dirty-schedule").hide(),$("form#add-unit select,input,button").prop("disabled",!0),button.prop("disabled",!1).text(gettext("Save changes"))}})},hide:function(unit){void 0!==unit&&(unit.hidden=!0)},show:function(unit){void 0!==unit&&(unit.hidden=!1)},get_datetime:function(which){var date=$("form#add-unit input[name="+which+"_date]").val(),time=$("form#add-unit input[name="+which+"_time]").val();return date&&time?date+" "+time:null},set_datetime:function(which,value){var parts=value?value.split(" "):["",""],date=parts[0],time=parts[1];$("form#add-unit input[name="+which+"_date]").val(date),$("form#add-unit input[name="+which+"_time]").val(time)},schedule_options:function(nodes){return nodes.map(function(node){return $("<option>").attr("value",node.location).text(node.display_name)[0]})},schedule_apply:function(nodes,f){nodes.map(function(node){f(node),void 0!==node&&void 0!==node.children&&self.schedule_apply(node.children,f)})},pruned:function(tree,filter){return tree.filter(filter).map(function(node){var copy={};return $.extend(copy,node),node.children&&(copy.children=self.pruned(node.children,filter)),copy}).filter(function(node){return void 0===node.children||node.children.length})},toggle_collapse:function(event){event.preventDefault();var row=$(this).closest("tr"),children=self.get_children(row);row.is(".expanded")?($(this).removeClass("fa-caret-down").addClass("fa-caret-right"),row.removeClass("expanded").addClass("collapsed"),children.hide()):($(this).removeClass("fa-caret-right").addClass("fa-caret-down"),row.removeClass("collapsed").addClass("expanded"),children.filter(".collapsed").each(function(){children=children.not(self.get_children(this))}),children.show())},enterNewDate:function(what){return function(){var row=$(this).closest("tr"),modal=$("#enter-date-modal").data("what",what).data("location",row.data("location"));modal.find("h2").text(gettext("due"===what?"Enter Due Date":"Enter Start Date")),modal.find("label").text(row.find("td:first").text());var path=row.data("location").split(" "),unit=self.find_unit(self.schedule,path[0],path[1],path[2]),parts=unit[what]?unit[what].split(" "):["",""],date=parts[0],time=parts[1];modal.find("input[name=date]").val(date),modal.find("input[name=time]").val(time),modal.find("form").off("submit").on("submit",function(event){event.preventDefault();var date=$(this).find("input[name=date]").val(),time=$(this).find("input[name=time]").val(),valid_date=new Date(date);if(isNaN(valid_date.valueOf()))return void alert("Please enter a valid date");var valid_time=/^\d{1,2}:\d{2}?$/;return time.match(valid_time)?("start"===what?unit.start=date+" "+time:unit.due=date+" "+time,modal.find(".close-modal").click(),self.dirty=!0,self.schedule_collection.set(self.schedule),void self.render()):void alert("Please enter a valid time")})}},find_unit:function(tree,chapter,sequential,vertical){var units=self.find_lineage(tree,chapter,sequential,vertical);return units[units.length-1]},find_lineage:function(tree,chapter,sequential,vertical){function find_in(seq,location){for(var i=0;i<seq.length;i++)if(seq[i].location===location)return seq[i]}var units=[],unit=find_in(tree,chapter);return units[units.length]=unit,sequential&&(units[units.length]=unit=find_in(unit.children,sequential),vertical&&(units[units.length]=unit=find_in(unit.children,vertical))),units},get_children:function(row){var depth=$(row).data("depth");return $(row).nextUntil($(row).siblings().filter(function(){return $(this).data("depth")<=depth}))}})}(jQuery,_,Backbone,gettext);